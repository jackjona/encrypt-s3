<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL File Encryption and Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      form {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input,
      button,
      progress {
        margin-top: 5px;
        display: block;
      }
      progress {
        width: 100%;
        height: 20px;
      }
      #uploadStatus,
      #downloadStatus {
        margin-top: 15px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Encrypt and Upload File via URL</h1>
    <form id="uploadForm">
      <label for="fileUrl">File URL:</label>
      <input
        type="text"
        id="fileUrl"
        placeholder="Enter the file URL"
        required
      />
      <label for="password">Password:</label>
      <input
        type="password"
        id="password"
        placeholder="Enter a password"
        required
      />
      <button type="submit">Encrypt & Upload</button>
    </form>
    <div id="uploadStatus"></div>

    <h1>Download and Decrypt File</h1>
    <form id="downloadForm">
      <label for="fileName">File Name:</label>
      <input
        type="text"
        id="fileName"
        placeholder="Enter file name"
        required
      />
      <label for="passwordDecrypt">Password:</label>
      <input
        type="password"
        id="passwordDecrypt"
        placeholder="Enter the password"
        required
      />
      <button type="submit">Download & Decrypt</button>
    </form>
    <div id="downloadStatus"></div>

    <script>
      // Function to fetch and encrypt the file
      async function fetchAndEncryptFile(url, password) {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error("Failed to fetch the file. Please check the URL.");
        }

        const fileBuffer = await response.arrayBuffer();
        if (fileBuffer.byteLength === 0) {
          throw new Error("The fetched file is empty.");
        }

        const iv = crypto.getRandomValues(new Uint8Array(12)); // IV length = 12 bytes
        const salt = crypto.getRandomValues(new Uint8Array(16)); // Salt length = 16 bytes

        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          new TextEncoder().encode(password),
          "PBKDF2",
          false,
          ["deriveKey"]
        );

        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256",
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt"]
        );

        const encryptedContent = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv: iv },
          key,
          fileBuffer
        );

        return { encryptedContent, iv, salt };
      }

      // Function to decrypt the file
      async function decryptFile(encryptedBuffer, password, iv, salt) {
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          new TextEncoder().encode(password),
          "PBKDF2",
          false,
          ["deriveKey"]
        );

        const key = await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: salt,
            iterations: 100000,
            hash: "SHA-256",
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          true,
          ["decrypt"]
        );

        return await crypto.subtle.decrypt(
          { name: "AES-GCM", iv: iv },
          key,
          encryptedBuffer
        );
      }

      // Upload Form Event Listener
      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileUrl = document.getElementById("fileUrl").value;
        const password = document.getElementById("password").value;
        const uploadStatus = document.getElementById("uploadStatus");

        uploadStatus.innerText = "Fetching and encrypting file...";

        try {
          const { encryptedContent, iv, salt } = await fetchAndEncryptFile(
            fileUrl,
            password
          );

          const encryptedFile = new Uint8Array(encryptedContent);

          // Create a progress bar
          const progressIndicator = document.createElement("progress");
          progressIndicator.max = encryptedFile.byteLength;
          progressIndicator.value = 0;
          uploadStatus.innerHTML = "Uploading file: ";
          uploadStatus.appendChild(progressIndicator);

          // Upload using XMLHttpRequest to track progress
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/upload", true);
          xhr.setRequestHeader("Content-Type", "application/json");

          xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
              progressIndicator.value = event.loaded;
              progressIndicator.max = event.total;
            }
          };

          xhr.onload = function () {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              uploadStatus.innerHTML = `File uploaded successfully! Filename: ${response.fileName}`;
            } else {
              const errorResponse = JSON.parse(xhr.responseText);
              uploadStatus.innerHTML = `Error: ${errorResponse.error}`;
            }
          };

          xhr.onerror = function () {
            uploadStatus.innerText = "Error occurred during upload.";
          };

          xhr.send(
            JSON.stringify({
              file: Array.from(encryptedFile),
              iv: Array.from(iv),
              salt: Array.from(salt),
            })
          );
        } catch (error) {
          uploadStatus.innerText = `Error: ${error.message}`;
        }
      });

      // Download Form Event Listener
      document.getElementById("downloadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileName = document.getElementById("fileName").value;
        const password = document.getElementById("passwordDecrypt").value;
        const downloadStatus = document.getElementById("downloadStatus");

        downloadStatus.innerText = "Downloading encrypted file...";
        try {
          const response = await fetch(`/download/${fileName}`);
          if (!response.ok) {
            throw new Error("Error downloading the file.");
          }

          const { encryptedContent, iv, salt } = await response.json();

          downloadStatus.innerText = "Decrypting file...";
          const decryptedBuffer = await decryptFile(
            new Uint8Array(encryptedContent).buffer,
            password,
            new Uint8Array(iv),
            new Uint8Array(salt)
          );

          // Create Blob and trigger file download
          const blob = new Blob([decryptedBuffer]);
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          a.click();

          // Success message
          console.log("The decrypted file has been successfully downloaded!");
          downloadStatus.innerText = "The decrypted file has been successfully downloaded!";
        } catch (error) {
          downloadStatus.innerText = `Error: ${error.message}`;
        }
      }); 
    </script>
  </body>
</html>
